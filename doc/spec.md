# 勤務記録管理アプリケーション仕様書

## 1. 概要

勤務時間と給料を計算・記録するWebアプリケーション。勤務時間、休憩時間、深夜手当（22:00-5:00 は 1.25倍）を考慮した給料計算を行い、CSV出力が可能。

## 2. 技術スタック

- **バックエンド**: Node.js + Express
- **データベース**: SQLite (ファイルベース: `records.db`)
- **フロントエンド**: HTML + Vanilla JavaScript (SPA)
- **テスト**: Playwright (E2Eテスト)

## 3. 主要機能

### 3.1 勤務記録の登録

#### 入力項目

- **勤務開始日時**: datetime-local形式
- **勤務終了日時**: datetime-local形式
- **休憩時間**: 複数設定可能（開始・終了のペア）
- **時給**: 数値（円）、デフォルト1000円

#### 計算ロジック

すべての計算は**フロントエンド**で実行される（`public/index.html:101-167`）:

1. **分単位の反復処理**:
   - 勤務開始から終了まで1分ずつループ処理
   - 各分について休憩時間かどうかをチェック
   - 休憩でない場合、実働時間としてカウント

2. **深夜時間の判定** (`index.html:134`):

   ```javascript
   if (hour >= 22 || hour < 5) nightMinutes++;
   ```

   - 22:00～23:59 または 0:00～4:59 を深夜時間帯として判定

3. **給料計算** (`index.html:140-142`):

   ```javascript
   totalSalary =
     ((workMinutes - nightMinutes) / 60) * hourlyRate +
     (nightMinutes / 60) * hourlyRate * 1.25;
   ```

   - 通常時間: `(実働分 - 深夜分) / 60 × 時給`
   - 深夜時間: `深夜分 / 60 × 時給 × 1.25`

4. **バックエンドへの送信**:
   - 計算済みの値を `POST /records` で保存
   - サーバーは計算の検証を行わず、受け取った値をそのまま保存

### 3.2 複数休憩時間の管理

- **休憩追加**: 「休憩を追加」ボタンで動的に入力フィールドを追加
- **休憩削除**: 各休憩ペアの「削除」ボタンで削除可能
- **休憩なし**: 休憩時間を入力しなくても保存可能
- **実装**: DOM操作による動的な `.break-pair` 要素の追加/削除 (`index.html:86-99`)

### 3.3 記録の表示

#### テーブル表示項目

- 勤務日（ローカライズされた日付文字列）
- 時間（開始～終了時刻）
- 休憩時間（複数ある場合は " / " で区切り）
- 実働時間（小数点2桁、単位: 時間）
- 深夜分（単位: 分）
- 給料（円、整数）
- 操作（削除ボタン）

#### 合計表示

画面下部に以下を表示:

```
合計：{実働時間の合計} 時間 ／ 深夜 {深夜分の合計} 分 ／ 給料 {給料の合計} 円
```

### 3.4 記録の削除

- 各行の「削除」ボタンで個別削除可能
- 削除後は自動的に記録一覧と合計値を再読み込み
- データベースから完全に削除される（永続的）

### 3.5 CSV出力

#### エンドポイント

`GET /records/csv` (`server.js:55-80`)

#### CSV形式

```csv
勤務日,時間,休憩時間,実働(時間),深夜分(分),給料(円)
10/10/2025,9:00:00 - 5:00:00,12:00:00 - 1:00:00,7,0,8400
...
合計,,,14.00,180,16000
```

#### 特徴

- **BOM付きUTF-8** (`\uFEFF`): Excel互換性のため
- **合計行**: 実働時間、深夜分、給料の合計を最終行に追加
- **ダウンロードファイル名**: `勤務記録.csv`

## 4. データベーススキーマ

### テーブル: `records`

| カラム名    | 型                  | 説明                                                        |
| ----------- | ------------------- | ----------------------------------------------------------- |
| `id`        | INTEGER PRIMARY KEY | 自動採番ID                                                  |
| `date`      | TEXT                | 勤務日（ローカライズされた文字列）                          |
| `time`      | TEXT                | 勤務時間範囲（例: "9:00:00 - 18:00:00"）                    |
| `breakTime` | TEXT                | 休憩時間（例: "12:00:00 - 13:00:00 / 15:00:00 - 15:15:00"） |
| `hours`     | REAL                | 実働時間（小数点2桁）                                       |
| `night`     | INTEGER             | 深夜勤務時間（分単位）                                      |
| `salary`    | INTEGER             | 給料（円、整数）                                            |

**重要**: すべての計算済み値がデータベースに保存される。サーバー側での再計算や検証は行わない。

## 5. API仕様

### 5.1 勤務記録の保存

```http
POST /records
Content-Type: application/json

{
  "date": "10/10/2025",
  "time": "9:00:00 - 18:00:00",
  "breakTime": "12:00:00 - 13:00:00",
  "hours": "8.00",
  "night": 0,
  "salary": 9600
}

Response: { "id": 1 }
```

### 5.2 勤務記録の取得

```http
GET /records

Response: [
  {
    "id": 1,
    "date": "10/10/2025",
    "time": "9:00:00 - 18:00:00",
    "breakTime": "12:00:00 - 13:00:00",
    "hours": 8.00,
    "night": 0,
    "salary": 9600
  },
  ...
]
```

### 5.3 勤務記録の削除

```http
DELETE /records/:id

Response: 200 OK
```

### 5.4 CSV出力

```http
GET /records/csv

Response: ファイルダウンロード (勤務記録.csv)
```

## 6. テストケース

### 6.1 基本的な勤務記録の登録フロー

#### テストケース 6.1.1: 勤務時間を入力して保存し、記録が表示される

**ファイル**: `tests/e2e/basic-workflow.spec.ts:23`

**手順**:

1. 勤務開始日時に "2025-10-10T09:00" を入力
2. 勤務終了日時に "2025-10-10T18:00" を入力
3. 休憩開始時刻に "2025-10-10T12:00" を入力
4. 休憩終了時刻に "2025-10-10T13:00" を入力
5. 時給に "1200" を入力
6. 「計算して保存」ボタンをクリック

**期待結果**:

- テーブルに "10/10/2025" が表示される
- テーブルに "9:00" と "6:00" が表示される
- 実働時間 "8 時間" が表示される
- 給料 "9600 円" が表示される（1200円 × 8時間）

#### テストケース 6.1.2: 合計欄に値が表示される

**ファイル**: `tests/e2e/basic-workflow.spec.ts:63`

**手順**:

1. 1件目: 2025-10-10 9:00-17:00（休憩12:00-13:00、時給1000円）を保存
2. 2件目: 2025-10-11 10:00-18:00（休憩12:00-13:00、時給1000円）を保存

**期待結果**:

- 合計欄が表示される
- 合計欄に "時間"、"分"、"円" の単位が含まれる
- 合計実働時間が "14.xx 時間" の形式で表示される

#### テストケース 6.1.3: 記録がない場合でもエラーにならない

**ファイル**: `tests/e2e/basic-workflow.spec.ts:108`

**手順**:

1. ページを開く（記録が0件の状態）

**期待結果**:

- 「勤務時間・給料計算」見出しが表示される
- 「保存された勤務記録」見出しが表示される
- エラーメッセージが表示されない

### 6.2 深夜勤務のシナリオ

#### テストケース 6.2.1: 深夜勤務時間が記録され、深夜手当が反映される

**ファイル**: `tests/e2e/night-shift.spec.ts:20`

**手順**:

1. 勤務開始日時に "2025-10-10T22:00" を入力
2. 勤務終了日時に "2025-10-11T05:00" を入力
3. 時給に "1000" を入力
4. 「計算して保存」ボタンをクリック

**期待結果**:

- 深夜勤務時間 "420 分"（7時間）が表示される
- 実働時間 "7 時間" が表示される
- 給料 "8750 円" が表示される（7時間 × 1000円 × 1.25）

#### テストケース 6.2.2: 深夜時間帯を含む勤務で正しく計算される

**ファイル**: `tests/e2e/night-shift.spec.ts:48`

**手順**:

1. 勤務開始日時に "2025-10-10T20:00" を入力
2. 勤務終了日時に "2025-10-11T01:00" を入力
3. 時給に "1000" を入力
4. 「計算して保存」ボタンをクリック

**期待結果**:

- 実働時間 "5 時間" が表示される
- 深夜勤務時間 "180 分"（3時間）が表示される
- 給料 "5750 円" が表示される（通常2時間 2000円 + 深夜3時間 3750円）

#### テストケース 6.2.3: 深夜時間帯に休憩がある場合

**ファイル**: `tests/e2e/night-shift.spec.ts:70`

**手順**:

1. 勤務開始日時に "2025-10-10T22:00" を入力
2. 勤務終了日時に "2025-10-11T06:00" を入力
3. 休憩時間に "2025-10-11T00:00" ～ "2025-10-11T01:00" を入力
4. 時給に "1000" を入力
5. 「計算して保存」ボタンをクリック

**期待結果**:

- 実働時間 "7 時間" が表示される（8時間 - 1時間休憩）
- 深夜勤務時間 "360 分"（6時間）が表示される
- 給料 "8500 円" が表示される（通常1時間 1000円 + 深夜6時間 7500円）

#### テストケース 6.2.4: 通常勤務（深夜なし）との比較

**ファイル**: `tests/e2e/night-shift.spec.ts:107`

**手順**:

1. 勤務開始日時に "2025-10-10T09:00" を入力
2. 勤務終了日時に "2025-10-10T17:00" を入力
3. 時給に "1000" を入力
4. 「計算して保存」ボタンをクリック

**期待結果**:

- 深夜勤務時間 "0 分" が表示される
- 給料 "8000 円" が表示される（深夜手当なし）

#### テストケース 6.2.5: 早朝時間帯（0:00-5:00）も深夜勤務として扱われる

**ファイル**: `tests/e2e/night-shift.spec.ts:124`

**手順**:

1. 勤務開始日時に "2025-10-10T03:00" を入力
2. 勤務終了日時に "2025-10-10T09:00" を入力
3. 時給に "1000" を入力
4. 「計算して保存」ボタンをクリック

**期待結果**:

- 実働時間 "6 時間" が表示される
- 深夜勤務時間 "120 分"（2時間）が表示される
- 給料 "6500 円" が表示される（深夜2時間 2500円 + 通常4時間 4000円）

### 6.3 複数休憩の管理

#### テストケース 6.3.1: 複数の休憩時間を追加できる

**ファイル**: `tests/e2e/multiple-breaks.spec.ts:20`

**手順**:

1. 勤務開始日時に "2025-10-10T09:00" を入力
2. 勤務終了日時に "2025-10-10T18:00" を入力
3. 1つ目の休憩: "2025-10-10T12:00" ～ "2025-10-10T13:00" を入力
4. 「休憩を追加」ボタンをクリック
5. 2つ目の休憩: "2025-10-10T15:00" ～ "2025-10-10T15:15" を入力
6. 「休憩を追加」ボタンをクリック
7. 3つ目の休憩: "2025-10-10T17:00" ～ "2025-10-10T17:10" を入力
8. 時給に "1000" を入力
9. 「計算して保存」ボタンをクリック

**期待結果**:

- 記録が保存される
- テーブルに複数の休憩時間が表示される（"12:00"、"3:00" などが含まれる）
- 実働時間が表示される

#### テストケース 6.3.2: 休憩を削除できる

**ファイル**: `tests/e2e/multiple-breaks.spec.ts:65`

**手順**:

1. 勤務時間を入力
2. 3つの休憩時間を追加
3. 休憩が3つあることを確認
4. 2つ目の休憩の「削除」ボタンをクリック
5. 時給を入力して保存

**期待結果**:

- 休憩が2つに減る
- 記録が正常に保存される

#### テストケース 6.3.3: 休憩なしでも保存できる

**ファイル**: `tests/e2e/multiple-breaks.spec.ts:107`

**手順**:

1. 勤務開始日時に "2025-10-10T09:00" を入力
2. 勤務終了日時に "2025-10-10T17:00" を入力
3. 時給に "1000" を入力（休憩時間は入力しない）
4. 「計算して保存」ボタンをクリック

**期待結果**:

- 記録が保存される
- 実働時間 "8 時間" が表示される

#### テストケース 6.3.4: 正しい実働時間が計算される

**ファイル**: `tests/e2e/multiple-breaks.spec.ts:124`

**手順**:

1. 勤務開始日時に "2025-10-10T09:00" を入力
2. 勤務終了日時に "2025-10-10T18:00" を入力
3. 休憩時間に "2025-10-10T12:00" ～ "2025-10-10T13:00" を入力
4. 時給に "1000" を入力
5. 「計算して保存」ボタンをクリック

**期待結果**:

- 実働時間 "8 時間" が表示される（9時間勤務 - 1時間休憩）
- 給料 "8000 円" が表示される（1000円 × 8時間）

### 6.4 記録の削除

#### テストケース 6.4.1: 記録を削除できる

**ファイル**: `tests/e2e/delete-records.spec.ts:20`

**手順**:

1. 2件の勤務記録を保存
2. テーブル内の行が2件あることを確認
3. 1件目の「削除」ボタンをクリック

**期待結果**:

- 記録が1件になる
- 残っている記録が2件目（10/11の記録）である

#### テストケース 6.4.2: すべての記録を削除できる

**ファイル**: `tests/e2e/delete-records.spec.ts:69`

**手順**:

1. 3件の記録を保存
2. 3件あることを確認
3. すべての記録を順番に削除

**期待結果**:

- 記録が0件になる

#### テストケース 6.4.3: 削除後に合計値が更新される

**ファイル**: `tests/e2e/delete-records.spec.ts:98`

**手順**:

1. 2件の記録を保存（それぞれ8時間、8000円）
2. 合計欄に "16" 時間と "16000" 円が表示されることを確認
3. 1件削除

**期待結果**:

- 合計欄が更新される
- 合計に "8" 時間と "8000" 円が表示される

#### テストケース 6.4.4: 削除ボタンが各行に表示される

**ファイル**: `tests/e2e/delete-records.spec.ts:133`

**手順**:

1. 1件の記録を保存

**期待結果**:

- テーブル行内に削除ボタンが表示される
- 削除ボタンがクリック可能である

#### テストケース 6.4.5: 削除後にページをリロードしても記録が消えたままである

**ファイル**: `tests/e2e/delete-records.spec.ts:150`

**手順**:

1. 1件の記録を保存
2. 記録を削除
3. 記録が0件になることを確認
4. ページをリロード

**期待結果**:

- リロード後も記録が0件である

### 6.5 CSV出力

#### テストケース 6.5.1: CSVファイルをダウンロードできる

**ファイル**: `tests/e2e/csv-download.spec.ts:22`

**手順**:

1. 勤務記録を1件保存
2. 「CSVで保存」ボタンをクリック

**期待結果**:

- ダウンロードが開始される
- ダウンロードされたファイル名が "勤務記録.csv" である
- ファイルが存在する

#### テストケース 6.5.2: ダウンロードされたCSVに勤務記録が含まれる

**ファイル**: `tests/e2e/csv-download.spec.ts:63`

**手順**:

1. 勤務記録を保存（2025-10-10 9:00-17:00、休憩12:00-13:00、時給1200円）
2. CSVをダウンロード
3. ファイルを読み込み

**期待結果**:

- ヘッダー行が含まれる（"勤務日", "時間", "休憩時間", "実働", "深夜分", "給料"）
- 勤務記録のデータが含まれる（"10/10/2025", "9:00", "5:00", "12:00", "1:00", "7", "8400"）

#### テストケース 6.5.3: 複数の記録を含むCSVをダウンロードできる

**ファイル**: `tests/e2e/csv-download.spec.ts:113`

**手順**:

1. 3件の記録を保存
2. CSVをダウンロード
3. ファイルを読み込み

**期待結果**:

- 3件の記録が含まれる（"10/10/2025", "10/11/2025", "10/12/2025"）
- 合計行が含まれる
- CSVの行数が5行以上である（ヘッダー + 3件 + 合計）

#### テストケース 6.5.4: CSVに合計行が含まれる

**ファイル**: `tests/e2e/csv-download.spec.ts:152`

**手順**:

1. 2件の記録を保存（それぞれ8時間、8000円）
2. CSVをダウンロード
3. ファイルを読み込み

**期待結果**:

- 合計行が含まれる（"合計"）
- 合計値が妥当な範囲である（16時間、16000円）

#### テストケース 6.5.5: 記録がない状態でもCSVをダウンロードできる

**ファイル**: `tests/e2e/csv-download.spec.ts:192`

**手順**:

1. 記録が0件の状態でCSVボタンをクリック

**期待結果**:

- ダウンロードが成功する
- ファイル名が "勤務記録.csv" である
- ヘッダーと合計行のみが含まれる

## 7. 制限事項・既知の問題

### 7.1 サーバー側の検証なし

- バックエンドは受け取った値をそのまま保存する
- 不正な値や矛盾した値でも保存される可能性がある
- フロントエンドの計算ロジックが唯一の検証ポイント

### 7.2 データベースマイグレーション

- スキーマ変更時の自動マイグレーション機能なし
- 手動でALTER TABLEを実行するか、DBファイルを削除して再作成が必要

### 7.3 日付・時刻の表示形式

- ブラウザのロケール設定に依存
- 環境によって表示形式が異なる可能性がある
- CSVも同様にローカライズされた形式で出力される

### 7.4 並行処理

- 複数ユーザーの同時アクセスを想定した排他制御なし
- ローカル環境や単一ユーザー用途を想定

## 8. 実行コマンド

### 開発サーバー起動

```bash
npm start
# http://localhost:3000 でアクセス
```

### 依存関係インストール

```bash
npm install
```

### E2Eテスト実行

```bash
# すべてのテストを実行
npm run test:e2e

# UIモードで実行
npm run test:e2e:ui

# ヘッドありモードで実行
npm run test:e2e:headed

# デバッグモードで実行
npm run test:e2e:debug
```

## 9. ファイル構成

```
work-tracker-app/
├── server.js                    # Expressサーバー（APIエンドポイント）
├── public/
│   └── index.html              # フロントエンド（SPA）
├── records.db                   # SQLiteデータベース（実行時自動生成）
├── tests/
│   └── e2e/
│       ├── basic-workflow.spec.ts      # 基本フロー
│       ├── night-shift.spec.ts         # 深夜勤務
│       ├── multiple-breaks.spec.ts     # 複数休憩
│       ├── delete-records.spec.ts      # 削除機能
│       └── csv-download.spec.ts        # CSV出力
├── package.json
├── playwright.config.ts
├── CLAUDE.md                    # プロジェクト指示書
└── spec.md                      # 本仕様書
```

## 10. 今後の拡張案

- [ ] サーバー側での入力値検証
- [ ] ユーザー認証機能
- [ ] 複数ユーザー対応
- [ ] 勤務記録の編集機能
- [ ] 月別・期間別の集計機能
- [ ] PDF出力機能
- [ ] データバックアップ・インポート機能
- [ ] レスポンシブデザイン対応
- [ ] 単体テストの追加（Jest等）
