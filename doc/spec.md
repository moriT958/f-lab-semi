# 勤務時間・給料計算アプリ 仕様書

## 1. アプリケーション概要

### 1.1 目的

勤務時間を記録し、深夜手当を含む給料を自動計算するWebアプリケーション。

### 1.2 技術スタック

- **バックエンド**: Node.js + Express
- **データベース**: SQLite (ファイルベース)
- **フロントエンド**: HTML/CSS/JavaScript (Vanilla JS)
- **アーキテクチャ**: モノリシックSPA（単一HTMLファイル）

### 1.3 開発履歴

このアプリは複数のAIプロンプトを通じて段階的に開発されました：

- 元々は支出記録アプリとして始まった
- 複数の休憩時間管理機能を追加
- データ削除とCSVエクスポート機能を追加

## 2. 機能一覧

### 2.1 勤務記録の登録

- **入力項目**:
  - 勤務開始日時（datetime-local）
  - 勤務終了日時（datetime-local）
  - 休憩時間（複数設定可能、開始・終了の組）
  - 時給（数値、デフォルト1000円）

- **出力**:
  - 実働時間（時間単位）
  - 深夜勤務時間（分単位）
  - 給料（円）

### 2.2 複数休憩時間の管理

- 「休憩を追加」ボタンで休憩時間のペアを動的に追加可能
- 各休憩時間ペアには「削除」ボタンが付属
- 休憩時間の入力は任意（空欄でも保存可能）

### 2.3 記録の表示

- 保存された全記録をテーブル形式で表示
- 表示項目：勤務日、時間、休憩、実働、深夜分、給料、操作
- 各行に「削除」ボタン表示
- ページ下部に合計値を表示（合計実働時間、深夜分、給料）

### 2.4 記録の削除

- 各記録に対して個別削除が可能
- 削除後、表示と合計値が自動更新
- データベースから永続的に削除

### 2.5 CSVエクスポート

- 全記録をCSVファイルでダウンロード
- ファイル名: `勤務記録.csv`
- エンコーディング: UTF-8 with BOM（Excel互換）
- 最終行に合計行を追加

## 3. 計算ロジック

### 3.1 時間計算のアルゴリズム

#### 3.1.1 分単位反復計算（フロントエンド実装）

勤務時間の計算は**フロントエンド（public/index.html:101-167）**で実行されます：

1. 勤務開始時刻から終了時刻まで**1分ごと**に反復
2. 各分について：
   - 休憩時間内か判定 → 休憩中ならスキップ
   - 深夜時間帯（22:00-5:00）か判定 → 該当すれば`nightMinutes++`
   - `workMinutes++`（実働分数カウント）

```javascript
// public/index.html:130-138の実装
while (t < end) {
  const inBreak = breakIntervals.some(([bs, be]) => t >= bs && t < be);
  if (!inBreak) {
    const hour = t.getHours();
    if (hour >= 22 || hour < 5) nightMinutes++;
    workMinutes++;
  }
  t.setMinutes(t.getMinutes() + 1);
}
```

#### 3.1.2 深夜手当の計算

- **深夜時間帯**: 22:00以降 または 5:00より前（`hour >= 22 || hour < 5`）
- **深夜割増率**: 1.25倍

```javascript
// public/index.html:140-142
totalSalary =
  ((workMinutes - nightMinutes) / 60) * hourlyRate +
  (nightMinutes / 60) * hourlyRate * 1.25;
```

**計算式の展開**:

- 通常勤務給料 = (実働分数 - 深夜分数) / 60 × 時給
- 深夜勤務給料 = 深夜分数 / 60 × 時給 × 1.25
- 合計給料 = 通常勤務給料 + 深夜勤務給料

**例**:

- 時給1000円、実働7時間（420分）、全て深夜勤務の場合：
- `(0 / 60) * 1000 + (420 / 60) * 1000 * 1.25 = 8750円`

### 3.2 休憩時間の扱い

- 休憩時間ペアの配列として管理
- 各分が休憩時間内かチェック: `t >= breakStart && t < breakEnd`
- 複数休憩の場合、いずれかの休憩時間内なら実働分数にカウントしない
- 空の休憩入力は無視される

## 4. データフロー

### 4.1 全体フロー

```
[フロントエンド]                [バックエンド]
    |                               |
入力値収集                           |
    |                               |
時間計算実行                          |
(分単位反復)                          |
    |                               |
給料計算完了                          |
    |                               |
POST /records  ------------------>  保存
(計算済みデータ)                    (SQLite)
    |                               |
GET /records   <------------------  取得
    |                               |
レンダリング                         |
```

### 4.2 重要な設計原則

#### フロントエンド主導の計算

- **すべての計算処理はフロントエンドで完結**
- バックエンドは計算済みの値を**そのまま保存するだけ**
- サーバーサイドでの検証や再計算は行わない

#### データの流れ

1. ユーザーが入力 → フロントエンドで計算
2. 計算結果をPOSTで送信
3. サーバーは受け取った値をそのままDB保存
4. GETで取得してフロントエンドで表示

**注意**: バックエンドは受動的なストレージレイヤーとして機能します（server.js:25-36）。

## 5. データベーススキーマ

### 5.1 テーブル定義（server.js:14-22）

```sql
CREATE TABLE IF NOT EXISTS records (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  date TEXT,
  time TEXT,
  breakTime TEXT,
  hours REAL,
  night INTEGER,
  salary INTEGER
)
```

### 5.2 カラム説明

| カラム名  | 型      | 説明                               | 例                                          |
| --------- | ------- | ---------------------------------- | ------------------------------------------- |
| id        | INTEGER | 主キー（自動採番）                 | 1, 2, 3...                                  |
| date      | TEXT    | 勤務日（ロケール文字列）           | "10/10/2025"                                |
| time      | TEXT    | 勤務時間範囲（開始-終了）          | "9:00:00 - 18:00:00"                        |
| breakTime | TEXT    | 休憩時間（複数は/区切り）          | "12:00:00 - 13:00:00 / 15:00:00 - 15:15:00" |
| hours     | REAL    | 実働時間（フロントエンド計算済み） | 7.58                                        |
| night     | INTEGER | 深夜勤務時間（分、計算済み）       | 180                                         |
| salary    | INTEGER | 給料（計算済み）                   | 8500                                        |

**重要**: すべての計算値（hours, night, salary）はフロントエンドで計算されてから保存されます。

## 6. API仕様

### 6.1 勤務記録保存

- **エンドポイント**: `POST /records`
- **リクエストボディ**:

```json
{
  "date": "10/10/2025",
  "time": "9:00:00 - 18:00:00",
  "breakTime": "12:00:00 - 13:00:00",
  "hours": "8.00",
  "night": 0,
  "salary": 8000
}
```

- **レスポンス**: `{ "id": 1 }`
- **エラー**: 500 (DB挿入エラー)

### 6.2 記録取得

- **エンドポイント**: `GET /records`
- **レスポンス**: レコード配列

```json
[
  {
    "id": 1,
    "date": "10/10/2025",
    "time": "9:00:00 - 18:00:00",
    "breakTime": "12:00:00 - 13:00:00",
    "hours": 8.0,
    "night": 0,
    "salary": 8000
  }
]
```

### 6.3 記録削除

- **エンドポイント**: `DELETE /records/:id`
- **パラメータ**: id（レコードID）
- **レスポンス**: 200 (成功)
- **エラー**: 500 (DB削除エラー)

### 6.4 CSVダウンロード

- **エンドポイント**: `GET /records/csv`
- **レスポンス**: ファイルダウンロード（Content-Disposition: attachment）
- **ファイル名**: `勤務記録.csv`
- **フォーマット**:

```csv
勤務日,時間,休憩時間,実働(時間),深夜分(分),給料(円)
10/10/2025,9:00:00 - 17:00:00,12:00:00 - 13:00:00,7.00,0,7000
10/11/2025,22:00:00 - 5:00:00,,7.00,420,8750
合計,,,14.00,420,15750
```

- **エンコーディング**: UTF-8 with BOM (`\uFEFF`)

## 7. UI/UX仕様

### 7.1 入力フォーム

- 勤務開始・終了日時：datetime-local入力（250px幅）
- 休憩時間：動的に追加可能な入力ペア
- 時給：数値入力（デフォルト1000円）
- ボタン：「計算して保存」「CSVで保存」

### 7.2 記録テーブル

- レスポンシブな全幅テーブル
- ボーダー付きセル、中央揃え
- 各行に削除ボタン

### 7.3 合計表示

- テーブル下に太字で表示
- フォーマット: `合計：XX.XX 時間 ／ 深夜 XX 分 ／ 給料 XXXXX 円`

### 7.4 日時表示フォーマット

- 日付: `toLocaleDateString()` → "10/10/2025"（ブラウザロケール依存）
- 時刻: `toLocaleTimeString()` → "9:00:00" または "9:00:00 AM"（ロケール依存）

## 8. 制約事項・既知の問題

### 8.1 バリデーションの欠如

- **サーバーサイドバリデーションなし**
  - 不正なデータ（開始>終了、負の時給など）がそのまま保存される
  - SQLインジェクションのリスク（現在はパラメータ化クエリで緩和）

- **フロントエンドバリデーション限定**
  - 基本的なチェックのみ（空欄チェック、NaNチェック）
  - 論理的なバリデーションは不十分

### 8.2 時刻表示のロケール依存性

- `toLocaleDateString()`, `toLocaleTimeString()`の使用により、ユーザーのブラウザロケール設定によって表示形式が変わる
- テストでは"9:00"と"9:00:00 AM"の両方の形式に対応が必要

### 8.3 パフォーマンス

- **分単位の反復計算**は長時間勤務で処理が重くなる可能性
- 例: 24時間勤務 = 1440回の反復
- 実用上は問題ないが、最適化の余地あり

### 8.4 データ永続性

- SQLiteファイルベース（`records.db`）
- マイグレーション機能なし
- スキーマ変更にはDBファイル削除または手動ALTERが必要

### 8.5 同時実行制御

- 複数ユーザーの同時アクセスは想定されていない
- SQLiteのロック機構に依存

## 9. セキュリティ考慮事項

### 9.1 実装済みの対策

- **パラメータ化クエリ**: SQLインジェクション対策（server.js:28-30）
- **静的ファイル提供**: Expressの`static`ミドルウェア使用

### 9.2 潜在的リスク

- 入力サニタイゼーション不足
- 認証・認可機能なし（ローカル使用想定）
- CSRF対策なし
- レート制限なし

## 10. テスト対象領域

### 10.1 既にテストされている機能

- 基本的な勤務記録の登録フロー
- 複数休憩時間の追加・削除
- 深夜手当計算（全深夜、部分深夜、早朝）
- CSV出力（内容、合計行、空状態）
- 記録削除（個別、全削除、合計更新、永続性）

### 10.2 テストが不足している領域

- 入力バリデーション（不正値、境界値）
- エッジケース（0分勤務、日付跨ぎ、極端な値）
- エラーハンドリング（DB障害、ネットワークエラー）
- 同時実行制御
- パフォーマンス（大量データ）
- ブラウザ互換性

## 11. 今後の改善提案

### 11.1 短期的改善

1. サーバーサイドバリデーションの追加
2. エラーメッセージの改善（ユーザーフィードバック）
3. 日時表示フォーマットの統一

### 11.2 中期的改善

1. 給料計算の検証機能（サーバーサイドでの再計算と検証）
2. データエクスポート形式の拡張（JSON, Excel）
3. 記録の編集機能

### 11.3 長期的改善

1. ユーザー認証・マルチユーザー対応
2. より堅牢なDBシステムへの移行（PostgreSQL等）
3. バックエンドでの計算ロジック実装（信頼性向上）

## 12. 参考情報

### 12.1 ソースコード構成

```
work-tracker-app/
├── server.js           # Expressサーバー、API、DB初期化
├── public/
│   └── index.html      # フロントエンドUI、計算ロジック
├── records.db          # SQLiteデータベース（自動生成）
├── tests/e2e/          # Playwrightテスト
└── doc/
    ├── prompts.md      # 開発プロンプト履歴
    └── spec.md         # 本仕様書
```

### 12.2 関連ドキュメント

- [CLAUDE.md](../CLAUDE.md): プロジェクト概要とアーキテクチャパターン
- [prompts.md](./prompts.md): AIプロンプト履歴
- [test-cases.md](./test-cases.md): テストケース一覧

### 12.3 主要ロジックの参照

- 時間計算: `public/index.html:130-138`
- 深夜判定: `public/index.html:134`
- 給料計算: `public/index.html:140-142`
- CSV生成: `server.js:55-80`
- DB保存: `server.js:25-36`
