# テストケース一覧

## 概要

このドキュメントでは、勤務時間・給料計算アプリの既存テストと不足しているテストケースをリストアップします。

## テスト構成

- **テストフレームワーク**: Playwright (E2Eテスト)
- **テストファイル数**: 6ファイル
- **既存テストケース数**: 23ケース

---

## 既存テストケース

### 1. 基本的な勤務記録の登録フロー (basic-workflow.spec.ts)

#### 1.1 勤務時間を入力して保存し、記録が表示される

- **目的**: 基本的な入力・保存・表示フローの確認
- **操作**:
  1. 勤務開始: 2025-10-10 09:00
  2. 勤務終了: 2025-10-10 18:00
  3. 休憩: 12:00-13:00
  4. 時給: 1200円
- **期待結果**:
  - テーブルに記録が表示される
  - 日付: "10/10/2025"
  - 時間: "9:00", "6:00"
  - 実働時間: "8 時間"
  - 給料: "9600 円"

#### 1.2 合計欄に値が表示される

- **目的**: 複数記録の合計計算機能の確認
- **操作**:
  1. 1件目: 2025-10-10 09:00-17:00, 休憩12:00-13:00, 時給1000円
  2. 2件目: 2025-10-11 10:00-18:00, 休憩12:00-13:00, 時給1000円
- **期待結果**:
  - 合計欄が表示される
  - "時間", "分", "円" の単位が含まれる
  - 合計値が14時間程度

#### 1.3 記録がない場合でもエラーにならない

- **目的**: 空状態でのアプリの安定性確認
- **操作**: ページを開くのみ
- **期待結果**:
  - 見出しが表示される
  - エラーメッセージが表示されない

---

### 2. 複数休憩の管理 (multiple-breaks.spec.ts)

#### 2.1 複数の休憩時間を追加できる

- **目的**: 動的な休憩追加機能の確認
- **操作**:
  1. 1つ目の休憩: 12:00-13:00
  2. 「休憩を追加」をクリック
  3. 2つ目の休憩: 15:00-15:15
  4. 「休憩を追加」をクリック
  5. 3つ目の休憩: 17:00-17:10
  6. 保存
- **期待結果**:
  - 記録が保存される
  - 休憩時間が複数表示される
  - 実働時間が正しく計算される（約7.58時間）

#### 2.2 休憩を削除できる

- **目的**: 休憩削除機能の確認
- **操作**:
  1. 3つの休憩を追加
  2. 2つ目の休憩の削除ボタンをクリック
- **期待結果**:
  - 休憩が2つに減る
  - 保存が正常に完了する

#### 2.3 休憩なしでも保存できる

- **目的**: 休憩入力が任意であることの確認
- **操作**:
  1. 勤務時間のみ入力（休憩なし）
  2. 保存
- **期待結果**:
  - 記録が保存される
  - 実働時間が8時間

#### 2.4 正しい実働時間が計算される

- **目的**: 休憩控除計算の精度確認
- **操作**:
  1. 9:00-18:00の勤務
  2. 12:00-13:00の休憩
  3. 時給1000円
- **期待結果**:
  - 実働時間: "8 時間"
  - 給料: "8000 円"

---

### 3. 深夜勤務のシナリオ (night-shift.spec.ts)

#### 3.1 深夜勤務時間が記録され、深夜手当が反映される

- **目的**: 完全な深夜勤務での計算確認
- **操作**:
  1. 22:00-翌5:00の勤務（7時間）
  2. 時給1000円
- **期待結果**:
  - 深夜分: "420 分" (7時間)
  - 実働: "7 時間"
  - 給料: "8750 円" (1000 × 7 × 1.25)

#### 3.2 深夜時間帯を含む勤務で正しく計算される

- **目的**: 通常+深夜混在勤務の計算確認
- **操作**:
  1. 20:00-翌1:00の勤務（5時間、うち深夜3時間）
  2. 時給1000円
- **期待結果**:
  - 実働: "5 時間"
  - 深夜分: "180 分" (3時間)
  - 給料: "5750 円" (通常2h=2000円 + 深夜3h=3750円)

#### 3.3 深夜時間帯に休憩がある場合

- **目的**: 深夜時間帯の休憩控除計算確認
- **操作**:
  1. 22:00-翌6:00の勤務（8時間）
  2. 0:00-1:00の休憩（深夜時間帯）
  3. 時給1000円
- **期待結果**:
  - 実働: "7 時間"
  - 深夜分: "360 分" (6時間、休憩1時間除く)
  - 給料: "8500 円" (通常1h=1000円 + 深夜6h=7500円)

#### 3.4 通常勤務（深夜なし）との比較

- **目的**: 深夜勤務がない場合の確認
- **操作**:
  1. 9:00-17:00の勤務
  2. 時給1000円
- **期待結果**:
  - 深夜分: "0 分"
  - 給料: "8000 円" (深夜手当なし)

#### 3.5 早朝時間帯（0:00-5:00）も深夜勤務として扱われる

- **目的**: 早朝深夜判定の確認
- **操作**:
  1. 3:00-9:00の勤務（6時間、うち深夜2時間）
  2. 時給1000円
- **期待結果**:
  - 実働: "6 時間"
  - 深夜分: "120 分" (2時間)
  - 給料: "6500 円" (深夜2h=2500円 + 通常4h=4000円)

---

### 4. CSV出力 (csv-download.spec.ts)

#### 4.1 CSVファイルをダウンロードできる

- **目的**: CSVダウンロード機能の基本確認
- **操作**:
  1. 1件の記録を保存
  2. 「CSVで保存」ボタンをクリック
- **期待結果**:
  - ダウンロードイベントが発生
  - ファイル名: "勤務記録.csv"
  - ファイルが存在する

#### 4.2 ダウンロードされたCSVに勤務記録が含まれる

- **目的**: CSV内容の正確性確認
- **操作**:
  1. 9:00-17:00, 休憩12:00-13:00, 時給1200円の記録を保存
  2. CSVダウンロード
- **期待結果**:
  - ヘッダー行が含まれる（勤務日、時間、休憩時間、実働、深夜分、給料）
  - データ行が含まれる（10/10/2025, 9:00, 5:00, 12:00, 1:00, 7, 8400）

#### 4.3 複数の記録を含むCSVをダウンロードできる

- **目的**: 複数レコードのCSV出力確認
- **操作**:
  1. 3件の記録を保存
  2. CSVダウンロード
- **期待結果**:
  - 3件の日付が含まれる（10/10/2025, 10/11/2025, 10/12/2025）
  - 合計行が含まれる
  - CSV行数が5行以上（ヘッダー + 3件 + 合計）

#### 4.4 CSVに合計行が含まれる

- **目的**: CSV合計行の確認
- **操作**:
  1. 2件の記録を保存（各8時間、時給1000円）
  2. CSVダウンロード
- **期待結果**:
  - "合計" という文字列が含まれる
  - 合計実働: "16"
  - 合計給料: "16000"

#### 4.5 記録がない状態でもCSVをダウンロードできる

- **目的**: 空状態でのCSV出力の安定性確認
- **操作**:
  1. 記録がない状態でCSVボタンをクリック
- **期待結果**:
  - ダウンロードが成功する
  - ヘッダーと合計行のみ含まれる

---

### 5. 記録の削除 (delete-records.spec.ts)

#### 5.1 記録を削除できる

- **目的**: 個別削除機能の確認
- **操作**:
  1. 2件の記録を保存
  2. 1件目の削除ボタンをクリック
- **期待結果**:
  - 記録が1件になる
  - 残っている記録が2件目（10/11の記録）

#### 5.2 すべての記録を削除できる

- **目的**: 全削除機能の確認
- **操作**:
  1. 3件の記録を保存
  2. すべての削除ボタンを順にクリック
- **期待結果**:
  - 記録が0件になる

#### 5.3 削除後に合計値が更新される

- **目的**: 削除後の合計再計算確認
- **操作**:
  1. 2件の記録を保存（各8時間、時給1000円）
  2. 1件削除
- **期待結果**:
  - 削除前の合計: 16時間、16000円
  - 削除後の合計: 8時間、8000円

#### 5.4 削除ボタンが各行に表示される

- **目的**: UI要素の存在確認
- **操作**:
  1. 1件の記録を保存
- **期待結果**:
  - 削除ボタンが表示される
  - 削除ボタンがクリック可能

#### 5.5 削除後にページをリロードしても記録が消えたままである

- **目的**: データベースからの永続的削除確認
- **操作**:
  1. 1件の記録を保存
  2. 削除
  3. ページをリロード
- **期待結果**:
  - リロード後も記録が0件

---

## 不足しているテストケース

### カテゴリA: 入力バリデーション

#### A1. 不正な日時入力

- **優先度**: 高
- **テストケース**:
  - A1-1: 勤務開始が勤務終了より後の場合（逆転）
  - A1-2: 勤務開始と勤務終了が同じ（0分勤務）
  - A1-3: 休憩開始が休憩終了より後の場合
  - A1-4: 休憩時間が勤務時間外の場合
  - A1-5: 日付入力欄が空の場合
- **期待動作**: エラーメッセージ表示 or バリデーション拒否
- **現状**: フロントエンドで簡易チェックのみ、不正値も保存される可能性

#### A2. 不正な時給入力

- **優先度**: 高
- **テストケース**:
  - A2-1: 負の時給（-1000円）
  - A2-2: 0円の時給
  - A2-3: 極端に大きい時給（100万円）
  - A2-4: 小数点時給（1234.56円）
  - A2-5: 時給入力欄が空の場合
- **期待動作**: エラーまたはデフォルト値適用
- **現状**: NaNチェックのみ

#### A3. 特殊文字・XSS対策

- **優先度**: 中
- **テストケース**:
  - A3-1: HTML特殊文字入力（`<script>alert('xss')</script>`）
  - A3-2: SQL特殊文字入力（`'; DROP TABLE records; --`）
  - A3-3: Unicode特殊文字（絵文字、制御文字）
- **期待動作**: エスケープまたはサニタイズ
- **現状**: パラメータ化クエリでSQL対策済み、XSSは未確認

---

### カテゴリB: 境界値テスト

#### B1. 深夜時間帯の境界

- **優先度**: 高
- **テストケース**:
  - B1-1: 21:59開始（深夜前）
  - B1-2: 22:00開始（深夜開始ちょうど）
  - B1-3: 22:01開始（深夜開始直後）
  - B1-4: 4:59終了（深夜終了直前）
  - B1-5: 5:00終了（深夜終了ちょうど）
  - B1-6: 5:01終了（深夜後）
  - B1-7: 21:59-22:01の勤務（境界またぎ、2分）
  - B1-8: 4:59-5:01の勤務（境界またぎ、2分）
- **期待動作**: 正確な深夜分数計算
- **現状**: 未テスト（境界値の精度未確認）

#### B2. 時間の極端な値

- **優先度**: 中
- **テストケース**:
  - B2-1: 0分勤務（開始=終了）
  - B2-2: 1分勤務
  - B2-3: 24時間勤務（丸一日）
  - B2-4: 48時間勤務（2日間連続）
  - B2-5: 極端に長い休憩（勤務時間と同じ）
- **期待動作**: 正しい計算またはエラー
- **現状**: 未テスト

#### B3. 日付の境界

- **優先度**: 低
- **テストケース**:
  - B3-1: 月末から月初への跨ぎ（1/31 23:00 - 2/1 01:00）
  - B3-2: 年末から年始への跨ぎ（12/31 23:00 - 1/1 01:00）
  - B3-3: 閏年の2/29
  - B3-4: 過去の日付（1年前）
  - B3-5: 未来の日付（1年後）
- **期待動作**: 日付をまたいでも正確な計算
- **現状**: 未テスト

---

### カテゴリC: エッジケース

#### C1. 休憩時間の複雑なパターン

- **優先度**: 中
- **テストケース**:
  - C1-1: 10個以上の休憩
  - C1-2: 休憩が重複している場合（12:00-13:00 と 12:30-13:30）
  - C1-3: 休憩が連続している場合（12:00-13:00 と 13:00-14:00）
  - C1-4: 休憩が勤務時間全体を覆う場合
  - C1-5: 休憩の順序が逆（後の休憩を先に入力）
- **期待動作**: 重複考慮した正確な計算またはエラー
- **現状**: 重複チェックなし、順不同で動作するかは未確認

#### C2. 日付跨ぎの複雑なケース

- **優先度**: 中
- **テストケース**:
  - C2-1: 日付を2回跨ぐ（1日目20:00 - 3日目02:00）
  - C2-2: 日付跨ぎ + 深夜 + 複数休憩の組み合わせ
  - C2-3: 夏時間（DST）切り替え時刻を跨ぐ場合（該当地域）
- **期待動作**: 正確な計算
- **現状**: 2日以上の跨ぎは未テスト

#### C3. 計算精度

- **優先度**: 低
- **テストケース**:
  - C3-1: 給料が小数点以下を持つ場合の丸め（1時間7分 × 1234円）
  - C3-2: 浮動小数点誤差の確認（0.1 + 0.2 ≠ 0.3問題）
  - C3-3: 大きな数値の計算（時給10万円 × 1000時間）
- **期待動作**: 正確な丸め処理
- **現状**: `Math.round()`使用、精度は未確認

---

### カテゴリD: データ整合性

#### D1. データベース操作

- **優先度**: 高
- **テストケース**:
  - D1-1: 同時に複数の記録を保存（並行リクエスト）
  - D1-2: 削除中に別の操作（保存、CSV出力）
  - D1-3: 存在しないIDの削除リクエスト
  - D1-4: DBファイルが読み取り専用の場合
  - D1-5: DBファイルが存在しない場合（初回起動）
- **期待動作**: エラーハンドリング、トランザクション整合性
- **現状**: エラーハンドリング不十分

#### D2. セッション・状態管理

- **優先度**: 中
- **テストケース**:
  - D2-1: ブラウザの戻る/進むボタン使用
  - D2-2: 複数タブで同時操作
  - D2-3: ページリロード中の操作
  - D2-4: 長時間放置後の操作
- **期待動作**: 状態の一貫性維持
- **現状**: 未テスト

---

### カテゴリE: エラーハンドリング

#### E1. ネットワークエラー

- **優先度**: 高
- **テストケース**:
  - E1-1: サーバーが停止している状態で保存
  - E1-2: サーバーが停止している状態でCSVダウンロード
  - E1-3: 保存中にネットワーク切断
  - E1-4: タイムアウト（長時間レスポンスなし）
  - E1-5: 不正なHTTPステータスコード（500, 503）
- **期待動作**: ユーザーフレンドリーなエラーメッセージ
- **現状**: エラーハンドリング未実装（fetch失敗時の挙動未確認）

#### E2. データベースエラー

- **優先度**: 高
- **テストケース**:
  - E2-1: ディスク容量不足
  - E2-2: DB破損
  - E2-3: ロック競合（SQLITE_BUSY）
  - E2-4: 制約違反（将来的に制約を追加した場合）
- **期待動作**: エラーログ記録、ユーザー通知
- **現状**: 500エラー返却のみ

#### E3. ファイル操作エラー

- **優先度**: 中
- **テストケース**:
  - E3-1: CSV生成時の書き込み権限なし
  - E3-2: CSVダウンロード中のキャンセル
  - E3-3: ディスク容量不足でCSV生成失敗
- **期待動作**: エラーメッセージ表示
- **現状**: 未確認

---

### カテゴリF: パフォーマンス

#### F1. 大量データ処理

- **優先度**: 中
- **テストケース**:
  - F1-1: 100件の記録を保存してCSV出力
  - F1-2: 1000件の記録を保存してCSV出力
  - F1-3: 10000件の記録の表示パフォーマンス
  - F1-4: 48時間勤務の計算時間（2880回反復）
  - F1-5: 同時に10個の休憩を持つ記録の計算時間
- **期待動作**: 合理的な処理時間（数秒以内）
- **現状**: 未測定

#### F2. メモリ使用量

- **優先度**: 低
- **テストケース**:
  - F2-1: 大量レコードロード時のメモリリーク確認
  - F2-2: 長時間使用時のメモリ増加確認
- **期待動作**: メモリリークなし
- **現状**: 未測定

---

### カテゴリG: UI/UX

#### G1. ユーザーインタラクション

- **優先度**: 中
- **テストケース**:
  - G1-1: 入力中のページリロード（入力値が失われる）
  - G1-2: 保存ボタンの連打（重複保存）
  - G1-3: 削除ボタンの連打（重複削除リクエスト）
  - G1-4: タブキーでのフォーカス移動
  - G1-5: Enterキーでのフォーム送信
- **期待動作**: 適切なフィードバック、重複防止
- **現状**: 重複防止なし

#### G2. レスポンシブデザイン

- **優先度**: 低
- **テストケース**:
  - G2-1: モバイル画面サイズでの表示
  - G2-2: タブレット画面サイズでの表示
  - G2-3: 極端に小さい画面（320px）
  - G2-4: 極端に大きい画面（4K）
- **期待動作**: レイアウト崩れなし
- **現状**: 未テスト

#### G3. アクセシビリティ

- **優先度**: 低
- **テストケース**:
  - G3-1: スクリーンリーダーでの操作
  - G3-2: キーボードのみでの操作
  - G3-3: ハイコントラストモード
  - G3-4: フォーカスインジケータの視認性
- **期待動作**: WCAG 2.1 AA準拠
- **現状**: 未評価

---

### カテゴリH: ブラウザ互換性

#### H1. 各種ブラウザでの動作確認

- **優先度**: 中
- **テストケース**:
  - H1-1: Chrome最新版
  - H1-2: Firefox最新版
  - H1-3: Safari最新版
  - H1-4: Edge最新版
  - H1-5: 旧バージョンブラウザ（Chrome 90など）
  - H1-6: モバイルブラウザ（iOS Safari, Chrome Mobile）
- **期待動作**: 一貫した動作
- **現状**: 未確認（開発環境のみ）

#### H2. ロケール依存性

- **優先度**: 中
- **テストケース**:
  - H2-1: 日本語ロケール（ja-JP）
  - H2-2: 英語ロケール（en-US）
  - H2-3: 24時間形式ロケール
  - H2-4: AM/PM形式ロケール
  - H2-5: 日付フォーマットの違い（MM/DD/YYYY vs DD/MM/YYYY）
- **期待動作**: ロケールに応じた適切な表示
- **現状**: toLocaleString()依存、統一性なし

---

### カテゴリI: セキュリティ

#### I1. SQLインジェクション

- **優先度**: 高
- **テストケース**:
  - I1-1: 日付フィールドにSQLコード挿入
  - I1-2: 時間フィールドにSQLコード挿入
  - I1-3: IDパラメータに不正値（`DELETE /records/1 OR 1=1`）
- **期待動作**: インジェクション無効化
- **現状**: パラメータ化クエリで対策済み（確認テストなし）

#### I2. XSS（クロスサイトスクリプティング）

- **優先度**: 高
- **テストケース**:
  - I2-1: 日付にスクリプトタグ挿入
  - I2-2: 時間にスクリプトタグ挿入
  - I2-3: イベントハンドラ属性挿入（`onerror="alert('xss')"`）
- **期待動作**: スクリプト実行されない
- **現状**: textContentまたはinnerHTML使用状況の確認必要

#### I3. CSRF（クロスサイトリクエストフォージェリ）

- **優先度**: 低（ローカルアプリのため）
- **テストケース**:
  - I3-1: 外部サイトからのPOSTリクエスト
  - I3-2: CSRFトークンなしでの操作
- **期待動作**: 拒否
- **現状**: 未実装（ローカル使用想定）

---

## テスト優先度マトリクス

| カテゴリ              | 優先度高 | 優先度中 | 優先度低 | 合計    |
| --------------------- | -------- | -------- | -------- | ------- |
| A: 入力バリデーション | 10       | 3        | 0        | 13      |
| B: 境界値テスト       | 8        | 6        | 5        | 19      |
| C: エッジケース       | 0        | 10       | 3        | 13      |
| D: データ整合性       | 5        | 4        | 0        | 9       |
| E: エラーハンドリング | 10       | 3        | 0        | 13      |
| F: パフォーマンス     | 0        | 5        | 2        | 7       |
| G: UI/UX              | 0        | 5        | 8        | 13      |
| H: ブラウザ互換性     | 0        | 8        | 0        | 8       |
| I: セキュリティ       | 5        | 0        | 1        | 6       |
| **合計**              | **38**   | **44**   | **19**   | **101** |

---

## 推奨実装順序

### フェーズ1: クリティカルな不足テスト（優先度高）

1. **入力バリデーション（A1, A2）**: 不正入力による予期しない動作を防ぐ
2. **エラーハンドリング（E1, E2）**: ネットワーク・DB障害時のユーザー体験改善
3. **境界値テスト（B1）**: 深夜手当計算の正確性（重要な給料計算）
4. **データ整合性（D1）**: 同時実行やDB操作の安定性
5. **セキュリティ（I1, I2）**: SQLインジェクション・XSS確認

### フェーズ2: 重要な機能テスト（優先度中）

1. **エッジケース（C1, C2）**: 複雑な休憩パターン、日付跨ぎ
2. **境界値テスト（B2）**: 極端な勤務時間
3. **パフォーマンス（F1）**: 大量データ処理
4. **UI/UX（G1）**: ユーザーインタラクション
5. **ブラウザ互換性（H1, H2）**: クロスブラウザ動作確認

### フェーズ3: 品質向上テスト（優先度低）

1. **境界値テスト（B3）**: 日付の境界
2. **エッジケース（C3）**: 計算精度
3. **パフォーマンス（F2）**: メモリ使用量
4. **UI/UX（G2, G3）**: レスポンシブ・アクセシビリティ
5. **セキュリティ（I3）**: CSRF対策（必要な場合）

---

## テスト実装のガイドライン

### 既存テストの特徴

- **beforeEach**: 各テスト前に既存レコードを削除（クリーンな状態）
- **waitForTimeout**: ネットワーク処理後に500msの待機
- **waitForLoadState("networkidle")**: ページロード完了を待機
- **ロケーター戦略**: `getByLabel`, `getByRole`, `locator`の組み合わせ

### 新規テスト実装時の注意点

1. **ロケール依存性**: 時刻表示が"9:00"または"9:00:00 AM"の両方に対応
2. **非同期処理**: fetch完了を適切に待機
3. **テストの独立性**: 各テストが他のテストに影響しないように
4. **エラーシナリオ**: Playwrightのネットワークモック機能を活用
5. **パフォーマンステスト**: `performance.now()`で計測、閾値を設定

### 推奨テストツール

- **E2Eテスト**: Playwright（既存）
- **ユニットテスト**: Jest（バックエンドロジック用、追加推奨）
- **負荷テスト**: Apache Bench or k6（パフォーマンステスト用）
- **セキュリティテスト**: OWASP ZAP or Burp Suite

---

## まとめ

### 既存カバレッジ

- **23テストケース**で基本的な機能は網羅
- ハッピーパス（正常系）は十分にテスト済み
- 主要機能（記録登録、複数休憩、深夜手当、CSV、削除）はカバー

### 不足領域

- **101の追加テストケース**を特定
- 特に**入力バリデーション**と**エラーハンドリング**が不足
- **境界値テスト**と**エッジケース**の精密な検証が必要
- **セキュリティテスト**の実施が推奨される

### 次のステップ

1. フェーズ1の優先度高テストを実装（38ケース）
2. バグ修正とバリデーション機能の追加
3. フェーズ2・3のテストを段階的に追加
4. CI/CDパイプラインへのテスト統合
